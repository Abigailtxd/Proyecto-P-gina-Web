<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor de Publicaciones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scrollbar personalizada solo para el modal */
    #modal .scrollable-modal {
      scrollbar-width: thin;
      scrollbar-color: #b22222 #fbeee6;
    }
    #modal .scrollable-modal::-webkit-scrollbar {
      width: 8px;
      background: #fbeee6cc;
      border-radius: 8px;
    }
    #modal .scrollable-modal::-webkit-scrollbar-thumb {
      background: #b22222b3;
      border-radius: 8px;
      border: 2px solid #fff0;
    }
    #modal .scrollable-modal::-webkit-scrollbar-track {
      background: #fbeee6cc;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#fbeee6] to-[#f7fafc] min-h-screen flex flex-col items-center font-sans">

  <h1 class="text-center text-4xl font-extrabold text-[#800000] mt-14 mb-10 tracking-wider drop-shadow-lg">Editor de Publicaciones</h1>

  <form id="formulario" class="bg-white/90 backdrop-blur rounded-3xl shadow-2xl max-w-md w-full p-10 flex flex-col gap-6 mb-12 border border-[#b22222]/20" onsubmit="return false;">
    <textarea id="texto" rows="3" placeholder="Contenido de la noticia." class="w-full rounded-xl border border-[#b22222] focus:border-[#800000] focus:ring-2 focus:ring-[#80000022] p-4 text-gray-800 text-base resize-vertical outline-none transition placeholder:italic placeholder:text-[#b22222]/60"></textarea>
    
    <input type="text" id="titulo" placeholder="Título de la noticia." class="rounded-xl border border-[#b22222] p-3 focus:border-[#800000] focus:ring-2 focus:ring-[#80000022] transition placeholder:italic placeholder:text-[#b22222]/60">

    <select id="tipo" class="rounded-xl border border-[#b22222] p-3 focus:border-[#800000] focus:ring-2 focus:ring-[#80000022] transition bg-white">
      <option value="principal">Principal</option>
      <option value="secundaria" selected>Secundaria</option>
    </select>

    <input type="text" id="imagenes" placeholder="URLs de imágenes (separadas por coma)." class="rounded-xl border border-[#b22222] p-3 focus:border-[#800000] focus:ring-2 focus:ring-[#80000022] transition placeholder:italic placeholder:text-[#b22222]/60">

    <select id="fuente" class="rounded-xl border border-[#b22222] p-3 focus:border-[#800000] focus:ring-2 focus:ring-[#80000022] transition bg-white">
      <option value="Arial" selected>Arial</option>
      <option value="Courier New">Courier New</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Verdana">Verdana</option>
      <option value="Georgia">Georgia</option>
    </select>

    <!-- le puse id al botón para cambiar el texto cuando editás -->
    <button id="btnPublicar" type="button" onclick="publicar()" class="w-full bg-gradient-to-r from-[#800000] to-[#b22222] text-white font-bold py-3 rounded-xl shadow-lg text-lg transition hover:from-[#4b0000] hover:to-[#800000] active:scale-95 tracking-wide">Publicar</button>
  </form>

  <h2 class="text-2xl font-bold text-[#800000] mb-8 tracking-wide">Publicaciones</h2>
  <div id="publicaciones" class="w-full max-w-3xl flex flex-col gap-8 px-2"></div>

  <!-- Modal para noticia detallada -->
  <div id="modal" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] relative flex flex-col gap-6">
      <div class="sticky top-0 left-0 right-0 bg-white rounded-t-3xl z-20 flex justify-end p-4">
        <button id="cerrarModal" class="text-[#b22222] hover:text-[#800000] text-2xl font-bold">&times;</button>
      </div>
      <div class="flex-1 overflow-y-auto scrollable-modal px-8 pb-8">
        <div id="modalContenido"></div>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
  Editor conectado a /api/publicaciones
  - GET /api/publicaciones
  - POST /api/publicaciones
  - PUT /api/publicaciones/:id (intentamos; si falla hacemos fallback)
  - DELETE /api/publicaciones/:id
  Mantiene TODO el estilo original (carrusel, modal, menú, select fuente, etc.)
----------------------------*/
const API_URL = "http://localhost:3000/api/publicaciones";
let publicaciones = [];
let editMode = false;
let editId = null;

/* ---------------------------
   Crear carrusel (copia extendida del original)
   devuelve un elemento DOM con interval automáticamente
----------------------------*/
function crearCarrusel(imagenes, id, grande = false) {
  if (!imagenes || imagenes.length === 0) return null;

  let index = 0;
  const cont = document.createElement("div");
  cont.className = "relative flex items-center justify-center mt-2 group";

  const img = document.createElement("img");
  img.src = imagenes[index];
  img.alt = "Imagen de la publicación";
  img.className = (grande
    ? "max-w-[520px] max-h-[340px] rounded-2xl border-2 border-[#b22222]/30 shadow-lg object-cover transition-all duration-500 aspect-video bg-white"
    : "max-w-[340px] max-h-[220px] rounded-xl border-2 border-[#b22222]/30 shadow-lg object-cover transition-all duration-500 aspect-video bg-white");
  cont.appendChild(img);

  if (imagenes.length > 1) {
    const indicadores = document.createElement("div");
    indicadores.className = "absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-10";
    imagenes.forEach((_, i) => {
      const dot = document.createElement("button");
      dot.className = "w-2.5 h-2.5 rounded-full transition-all duration-300 border border-[#b22222] " +
        (i === index ? "bg-[#b22222] scale-110 shadow" : "bg-white/80 hover:bg-[#b22222]/60");
      dot.onclick = (e) => {
        e.stopPropagation();
        index = i;
        img.src = imagenes[index];
        actualizarIndicadores();
        reiniciarAutoSlide();
      };
      indicadores.appendChild(dot);
    });
    cont.appendChild(indicadores);

    function actualizarIndicadores() {
      Array.from(indicadores.children).forEach((dot, i) => {
        dot.className = "w-2.5 h-2.5 rounded-full transition-all duration-300 border border-[#b22222] " +
          (i === index ? "bg-[#b22222] scale-110 shadow" : "bg-white/80 hover:bg-[#b22222]/60");
      });
    }

    const btnPrev = document.createElement("button");
    btnPrev.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>';
    btnPrev.className = "absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-[#800000] hover:text-white text-[#800000] rounded-full p-1.5 shadow transition opacity-0 group-hover:opacity-100";
    btnPrev.onclick = (e) => {
      e.stopPropagation();
      index = (index - 1 + imagenes.length) % imagenes.length;
      img.src = imagenes[index];
      actualizarIndicadores();
      reiniciarAutoSlide();
    };
    cont.appendChild(btnPrev);

    const btnNext = document.createElement("button");
    btnNext.innerHTML = '<svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>';
    btnNext.className = "absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-[#800000] hover:text-white text-[#800000] rounded-full p-1.5 shadow transition opacity-0 group-hover:opacity-100";
    btnNext.onclick = (e) => {
      e.stopPropagation();
      index = (index + 1) % imagenes.length;
      img.src = imagenes[index];
      actualizarIndicadores();
      reiniciarAutoSlide();
    };
    cont.appendChild(btnNext);

    // Auto-slide
    let interval = setInterval(() => {
      index = (index + 1) % imagenes.length;
      img.src = imagenes[index];
      actualizarIndicadores();
    }, 3500);

    function reiniciarAutoSlide() {
      clearInterval(interval);
      interval = setInterval(() => {
        index = (index + 1) % imagenes.length;
        img.src = imagenes[index];
        actualizarIndicadores();
      }, 3500);
    }

    // Limpiar intervalo al remover el carrusel
    cont.addEventListener("DOMNodeRemoved", () => clearInterval(interval));
  }

  return cont;
}

/* ---------------------------
   Util: truncar texto
----------------------------*/
function truncarTexto(texto, maxLength = 220) {
  if (!texto) return "";
  if (texto.length <= maxLength) return texto;
  const corte = texto.lastIndexOf(" ", maxLength - 3);
  return texto.slice(0, corte > 0 ? corte : maxLength - 3) + "…";
}

/* ---------------------------
   Cargar publicaciones desde backend
----------------------------*/
async function cargar() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("No se pudo obtener publicaciones");
    publicaciones = await res.json();

    // convertir imagen_url -> imagenes[] para mantener carrusel
    publicaciones.forEach(p => {
      // algunos registros podrían almacenar varias urls separadas por coma en imagen_url
      if (p.imagen_url && p.imagen_url.includes(",")) {
        p.imagenes = p.imagen_url.split(",").map(s => s.trim()).filter(Boolean);
      } else {
        p.imagenes = p.imagen_url ? [p.imagen_url] : [];
      }
      p.fuente = p.fuente || "Arial";
    });

    renderizar();
  } catch (err) {
    console.error("Error al cargar publicaciones:", err);
  }
}

/* ---------------------------
   Publicar (POST) o Guardar cambios (PUT con fallback)
----------------------------*/
async function publicar() {
  const titulo = document.getElementById("titulo").value.trim();
  const texto = document.getElementById("texto").value.trim();
  const tipo = document.getElementById("tipo").value;
  const imagenesInput = document.getElementById("imagenes").value;
  const imagenes = imagenesInput.split(",").map(s => s.trim()).filter(s => s);
  const fuente = document.getElementById("fuente").value || "Arial";
  const imagen_url = imagenes.length ? imagenes[0] : null;

  if (!titulo && !texto && !imagen_url) return;

  // Si estamos en modo edición, actualizamos (PUT) el registro editId
  if (editMode && editId) {
    const data = { titulo, descripcion: texto, imagen_url, fuente, tipo };
    const ok = await actualizarPublicacion(editId, data);
    if (ok) {
      editMode = false;
      editId = null;
      document.getElementById("btnPublicar").textContent = "Publicar";
      document.getElementById("formulario").reset();
      await cargar();
    }
    return;
  }

  // Crear nueva publicación (POST)
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ titulo, descripcion: texto, imagen_url, fuente, tipo })
    });
    if (res.ok) {
      document.getElementById("formulario").reset();
      await cargar();
    } else {
      console.error("Error al publicar:", res.statusText);
    }
  } catch (err) {
    console.error("Error al publicar:", err);
  }
}

/* ---------------------------
   Intentar PUT, si falla -> fallback: DELETE + POST
   (esto asegura que EDIT funcione aunque el backend PUT no actualice todos los campos)
----------------------------*/
async function actualizarPublicacion(id, data) {
  try {
    const res = await fetch(`${API_URL}/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    if (res.ok) return true;
    // si PUT no fue ok, intentamos fallback
    console.warn("PUT falló, intentando fallback (DELETE+POST).");
  } catch (err) {
    console.warn("PUT arrojó error:", err);
  }

  // fallback: borrar y crear nueva (mantiene continuidad visual, la id cambiará)
  try {
    await fetch(`${API_URL}/${id}`, { method: "DELETE" });
    const postRes = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    return postRes.ok;
  } catch (err) {
    console.error("Fallback de actualización falló:", err);
    return false;
  }
}

/* ---------------------------
   Eliminar publicación (usa id real en DB)
----------------------------*/
async function eliminarPublicacion(idx) {
  const pub = publicaciones[idx];
  if (!pub || !pub.id) {
    // si por alguna razón no hay id, sólo removemos localmente
    if (confirm("¿Seguro que deseas eliminar esta publicación local?")) {
      publicaciones.splice(idx, 1);
      renderizar();
    }
    return;
  }

  if (!confirm("¿Seguro que deseas eliminar esta publicación?")) return;

  try {
    const res = await fetch(`${API_URL}/${pub.id}`, { method: "DELETE" });
    if (res.ok) {
      await cargar();
    } else {
      console.error("Error al eliminar:", res.statusText);
    }
  } catch (err) {
    console.error("Error al eliminar:", err);
  }
}

/* ---------------------------
   Editar publicación: cargar datos en el formulario
----------------------------*/
function editarPublicacion(idx) {
  const pub = publicaciones[idx];
  if (!pub) return;
  document.getElementById("titulo").value = pub.titulo || "";
  document.getElementById("texto").value = pub.descripcion || "";
  document.getElementById("tipo").value = pub.tipo || "secundaria";
  document.getElementById("imagenes").value = (pub.imagenes || []).join(", ");
  document.getElementById("fuente").value = pub.fuente || "Arial";

  editMode = true;
  editId = pub.id || null;
  document.getElementById("btnPublicar").textContent = "Guardar cambios";
  // scroll to top so user sees the form (optional)
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ---------------------------
   Renderizado (manteniendo el estilo original)
----------------------------*/
function renderizar() {
  const cont = document.getElementById("publicaciones");
  cont.innerHTML = "";
  publicaciones.forEach((p, idx) => {
    const div = document.createElement("div");
    div.className = `publicacion relative flex flex-col md:flex-row gap-8 p-8 rounded-3xl shadow-xl border-l-[8px] 
      ${p.tipo === "principal" ? "border-[#800000] bg-gradient-to-br from-[#fff0f0] to-white" : "border-[#b22222] bg-white/90"}
      hover:shadow-[0_8px_32px_0_rgba(128,0,0,0.13)] transition duration-300`;

    // Menú desplegable
    const menuWrap = document.createElement("div");
    menuWrap.className = "absolute top-4 left-4 z-10";
    const menuBtn = document.createElement("button");
    menuBtn.type = "button";
    menuBtn.innerHTML = `<svg class="w-8 h-8 text-[#800000] hover:text-[#b22222] transition" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/>
    </svg>`;
    menuBtn.className = "focus:outline-none";
    menuWrap.appendChild(menuBtn);

    const menu = document.createElement("div");
    menu.className = "hidden absolute left-0 mt-2 w-36 bg-white rounded-xl shadow-lg border border-[#b22222]/20 z-20";
    menu.innerHTML = `
      <button class="w-full text-left px-5 py-3 hover:bg-yellow-100 text-[#b28500] font-semibold transition" type="button">Editar</button>
      <button class="w-full text-left px-5 py-3 hover:bg-[#ffeaea] text-[#b22222] font-semibold rounded-b-xl transition" type="button">Eliminar</button>
    `;
    menuWrap.appendChild(menu);

    menuBtn.onclick = (e) => {
      e.stopPropagation();
      // ocultar otros
      document.querySelectorAll(".menu-acciones").forEach(m => { if (m !== menu) m.classList.add("hidden"); });
      menu.classList.toggle("hidden");
    };
    document.addEventListener("click", () => document.querySelectorAll(".menu-acciones").forEach(m => m.classList.add("hidden")));
    // asociar acciones (capturamos idx actual)
    menu.children[0].onclick = (e) => { e.stopPropagation(); menu.classList.add("hidden"); editarPublicacion(idx); };
    menu.children[1].onclick = (e) => { e.stopPropagation(); menu.classList.add("hidden"); eliminarPublicacion(idx); };
    menu.classList.add("menu-acciones");
    div.appendChild(menuWrap);

    // Carrusel de imágenes (tamaño normal)
    const carrusel = crearCarrusel(p.imagenes, p.id, false);
    if (carrusel) {
      const imgWrap = document.createElement("div");
      imgWrap.className = "flex-shrink-0 flex items-center justify-center";
      imgWrap.appendChild(carrusel);
      div.appendChild(imgWrap);
    }

    // Contenido textual
    const contenido = document.createElement("div");
    contenido.className = "flex flex-col justify-between flex-1";

    // Título
    const titulo = document.createElement("h4");
    titulo.textContent = p.titulo || "";
    titulo.className = "text-2xl font-extrabold text-[#800000] mb-1 tracking-wide";
    contenido.appendChild(titulo);

    // Tipo
    const tipoSpan = document.createElement("span");
    tipoSpan.textContent = p.tipo ? (p.tipo.charAt(0).toUpperCase() + p.tipo.slice(1)) : "Secundaria";
    tipoSpan.className = `inline-block px-4 py-1 rounded-full text-xs font-semibold mb-3 shadow ${p.tipo === "principal" ? "bg-[#800000] text-white" : "bg-[#b22222] text-white"}`;
    contenido.appendChild(tipoSpan);

    // Descripción truncada
    const desc = document.createElement("p");
    desc.textContent = truncarTexto(p.descripcion || "", 220);
    desc.style.fontFamily = p.fuente || "Arial";
    desc.className = "text-gray-800 text-lg mb-4 leading-relaxed";
    contenido.appendChild(desc);

    // Fuente (select para cambiar y persistir)
    const fuenteWrap = document.createElement("div");
    fuenteWrap.className = "flex items-center gap-2 mt-2";
    const fuenteLabel = document.createElement("span");
    fuenteLabel.textContent = "Fuente:";
    fuenteLabel.className = "text-xs text-gray-500 italic";
    fuenteWrap.appendChild(fuenteLabel);

    const fuenteSelect = document.createElement("select");
    ["Arial", "Courier New", "Times New Roman", "Verdana", "Georgia"].forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      if ((p.fuente || "Arial") === f) opt.selected = true;
      fuenteSelect.appendChild(opt);
    });
    fuenteSelect.className = "rounded border border-[#b22222] px-2 py-1 text-xs focus:border-[#800000] focus:ring-1 focus:ring-[#80000022] transition";
    fuenteSelect.onchange = async () => {
      const nueva = fuenteSelect.value;
      // intentamos actualizar solo la fuente en backend
      const data = { descripcion: p.descripcion || "", fuente: nueva, tamano: null };
      // usamos la función actualizarPublicacion (que hace PUT o fallback)
      const ok = await actualizarPublicacion(p.id, { titulo: p.titulo, descripcion: p.descripcion, imagen_url: p.imagenes.join(", "), fuente: nueva, tipo: p.tipo });
      if (ok) {
        // recargar para reflejar persistencia real
        await cargar();
      } else {
        // si no pudo, actualizamos localmente para no romper UX
        p.fuente = nueva;
        renderizar();
      }
    };
    fuenteWrap.appendChild(fuenteSelect);
    contenido.appendChild(fuenteWrap);

    // Botón Ver más (abre modal)
    const verMasBtn = document.createElement("button");
    verMasBtn.textContent = "Ver más";
    verMasBtn.className = "mt-4 self-start bg-gradient-to-r from-[#800000] to-[#b22222] text-white font-semibold px-6 py-2 rounded-lg shadow transition hover:from-[#4b0000] hover:to-[#800000] active:scale-95";
    verMasBtn.onclick = () => mostrarDetalle(p);
    contenido.appendChild(verMasBtn);

    div.appendChild(contenido);

    // Sombra decorativa
    div.style.boxShadow = "0 8px 32px 0 rgba(128,0,0,0.10), 0 1.5px 8px 0 rgba(178,34,34,0.08)";

    cont.appendChild(div);
  });
}

/* ---------------------------
   Mostrar detalle en modal (carrusel grande y texto completo)
----------------------------*/
function mostrarDetalle(pub) {
  const modal = document.getElementById("modal");
  const modalContenido = document.getElementById("modalContenido");
  modalContenido.innerHTML = "";

  const titulo = document.createElement("h3");
  titulo.textContent = pub.titulo || "";
  titulo.className = "text-3xl font-extrabold text-[#800000] mb-2";
  modalContenido.appendChild(titulo);

  const tipo = document.createElement("span");
  tipo.textContent = pub.tipo ? (pub.tipo.charAt(0).toUpperCase() + pub.tipo.slice(1)) : "Secundaria";
  tipo.className = `inline-block px-4 py-1 rounded-full text-xs font-semibold mb-3 shadow ${pub.tipo === "principal" ? "bg-[#800000] text-white" : "bg-[#b22222] text-white"}`;
  modalContenido.appendChild(tipo);

  const carrusel = crearCarrusel(pub.imagenes, pub.id + "_detalle", true);
  if (carrusel) {
    const imgWrap = document.createElement("div");
    imgWrap.className = "flex items-center justify-center my-4";
    imgWrap.appendChild(carrusel);
    modalContenido.appendChild(imgWrap);
  }

  const desc = document.createElement("p");
  desc.textContent = pub.descripcion || "";
  desc.style.fontFamily = pub.fuente || "Arial";
  desc.className = "text-gray-800 text-lg mb-4 leading-relaxed";
  modalContenido.appendChild(desc);

  const fuente = document.createElement("span");
  fuente.textContent = `Fuente: ${pub.fuente || "Arial"}`;
  fuente.className = "text-xs text-gray-500 italic";
  modalContenido.appendChild(fuente);

  modal.classList.remove("hidden");
}

/* ---------------------------
   Modal: cerrar
----------------------------*/
document.getElementById("cerrarModal").onclick = function() {
  document.getElementById("modal").classList.add("hidden");
};
document.getElementById("modal").onclick = function(e) {
  if (e.target === this) this.classList.add("hidden");
};

/* ---------------------------
   Iniciar: cargar desde backend
----------------------------*/
cargar();

</script>
</body>
</html>
